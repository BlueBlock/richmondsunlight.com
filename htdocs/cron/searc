<?php

/**
 * Generate bulk JSON for indexing by Elasticsearch.
 */

/*
 * Create our indexing directory, if it doesn't exist.
 */
$dir_name = 'search_index';
if (file_exists($dir_name) === FALSE)
{
	if (!mkdir($dir_name, 0755))
	{
		$log->put('Could not create directory to index bills.', 7);
		die();
	}
}
chdir($dir_name);

/*
 * Get a list of what's already been exported.
 */
$files = scandir('.');

/*
 * Assemble the SQL query.
 */
$sql = 'SELECT sessions.year, bills.number, bills.catch_line, bills.summary, bills.full_text, bills.interestingness
		FROM bills
		LEFT JOIN sessions
			ON bills.session_id = sessions.id';


/*
 * If we already have files exported, then only get the bills that have been changed since
 * the most recently-exported file.
 */
if (count($files) > 2)
{
	//$last_exported = '';
	//$sql .= ' WHERE DATEDIFF(date_modified, ' . $last_exported . ') < 1';
}

/*
 * Iterate through the results.
 */
$sth = $dbh->prepare($sql);
$sth->execute();
while ($bill = $sth->fetchObject())
{

	/*
	 * Export as JSON.
	 */
	$json = json_encode($bill);

	$filename = $bill->year . '-' . $bill->number . '.json';
	if (!file_put_contents($filename, $json))
	{
		$log->put($bill->number . ' (' .$bill->year . ') could not be exported as JSON for indexing.', 3);
	}

}
